<!-- Create app/views/admin/checkin/bulk_checkin.html.erb -->

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Bulk Check-in: <%= @event.name %></h1>
        <div>
          <%= link_to "Back to Dashboard", checkin_dashboard_admin_event_path(@event), class: "btn btn-secondary" %>
        </div>
      </div>

      <% if @participants.any? %>
        <div class="card mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">Manual Check-in Instructions</h5>
          </div>
          <div class="card-body">
            <p>Use this interface to manually check in participants who don't have QR codes or when scanning isn't available.</p>
            <ul>
              <li>Select participants from the list below</li>
              <li>Click "Check In Selected" to process multiple participants at once</li>
              <li>Only participants who RSVP'd "Yes" or "Maybe" are shown</li>
              <li>Already checked-in participants are excluded</li>
            </ul>
          </div>
        </div>

        <%= form_with url: bulk_checkin_admin_event_path(@event), method: :patch, local: true, id: 'bulk-checkin-form' do |form| %>
          <div class="card">
            <div class="card-header">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <h5 class="mb-0">Participants Awaiting Check-in (<%= @participants.count %>)</h5>
                </div>
                <div class="col-md-6 text-end">
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="select-all">
                    Select All
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="clear-all">
                    Clear All
                  </button>
                  <span id="selected-count" class="ms-3 text-muted">0 selected</span>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th width="50">
                        <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                      </th>
                      <th>Name</th>
                      <th>Email</th>
                      <th>RSVP Status</th>
                      <th>Phone</th>
                      <th>Custom Responses</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @participants.each do |participant| %>
                      <tr>
                        <td>
                          <%= check_box_tag "participant_ids[]", participant.id, false, 
                                { class: "participant-checkbox form-check-input" } %>
                        </td>
                        <td>
                          <strong><%= participant.user.first_name %> <%= participant.user.last_name %></strong>
                        </td>
                        <td><%= participant.user.email %></td>
                        <td>
                          <span class="badge bg-<%= participant.rsvp_status == 'yes' ? 'success' : 'warning' %>">
                            <%= participant.rsvp_status_text %>
                          </span>
                        </td>
                        <td><%= participant.user.phone || '-' %></td>
                        <td>
                          <% if participant.has_custom_answers? %>
                            <button type="button" class="btn btn-sm btn-outline-info" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#responses-<%= participant.id %>-modal">
                              View Responses
                            </button>
                          <% else %>
                            <span class="text-muted">-</span>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="card-footer">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <div class="form-check">
                    <%= form.check_box :send_notifications, { checked: true, class: "form-check-input" } %>
                    <%= form.label :send_notifications, "Send check-in confirmation emails", class: "form-check-label" %>
                  </div>
                </div>
                <div class="col-md-6 text-end">
                  <%= form.submit "Check In Selected Participants", 
                        class: "btn btn-success btn-lg", 
                        id: "bulk-submit", 
                        disabled: true %>
                </div>
              </div>
            </div>
          </div>
        <% end %>

      <% else %>
        <div class="card">
          <div class="card-body text-center py-5">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h4>All Participants Checked In</h4>
            <p class="text-muted">There are no participants awaiting check-in.</p>
            <%= link_to "Return to Dashboard", checkin_dashboard_admin_event_path(@event), class: "btn btn-primary" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Custom Response Modals -->
<% @participants.each do |participant| %>
  <% if participant.has_custom_answers? %>
    <div class="modal fade" id="responses-<%= participant.id %>-modal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              Custom Responses - <%= participant.user.first_name %> <%= participant.user.last_name %>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <% if @event.custom_questions.present? %>
              <% @event.custom_questions.each_with_index do |question, index| %>
                <% answer = participant.rsvp_answers&.dig("question_#{index}") %>
                <div class="mb-3">
                  <strong><%= question %></strong>
                  <p class="mb-0 text-muted">
                    <%= answer.present? ? answer : "No response provided" %>
                  </p>
                </div>
              <% end %>
            <% end %>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  <% end %>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAllCheckbox = document.getElementById('select-all-checkbox');
  const participantCheckboxes = document.querySelectorAll('.participant-checkbox');
  const selectedCount = document.getElementById('selected-count');
  const bulkSubmit = document.getElementById('bulk-submit');
  const selectAllBtn = document.getElementById('select-all');
  const clearAllBtn = document.getElementById('clear-all');

  function updateSelectedCount() {
    const checked = document.querySelectorAll('.participant-checkbox:checked').length;
    selectedCount.textContent = `${checked} selected`;
    bulkSubmit.disabled = checked === 0;
    
    // Update select all checkbox state
    if (checked === 0) {
      selectAllCheckbox.indeterminate = false;
      selectAllCheckbox.checked = false;
    } else if (checked === participantCheckboxes.length) {
      selectAllCheckbox.indeterminate = false;
      selectAllCheckbox.checked = true;
    } else {
      selectAllCheckbox.indeterminate = true;
    }
  }

  // Select/deselect all
  selectAllCheckbox.addEventListener('change', function() {
    participantCheckboxes.forEach(checkbox => {
      checkbox.checked = this.checked;
    });
    updateSelectedCount();
  });

  // Individual checkbox changes
  participantCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedCount);
  });

  // Select all button
  selectAllBtn.addEventListener('click', function() {
    participantCheckboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
    updateSelectedCount();
  });

  // Clear all button
  clearAllBtn.addEventListener('click', function() {
    participantCheckboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    updateSelectedCount();
  });

  // Form submission confirmation
  document.getElementById('bulk-checkin-form').addEventListener('submit', function(e) {
    const checked = document.querySelectorAll('.participant-checkbox:checked').length;
    
    if (checked === 0) {
      e.preventDefault();
      alert('Please select at least one participant to check in.');
      return;
    }
    
    if (!confirm(`Check in ${checked} participants?`)) {
      e.preventDefault();
    }
  });

  // Initial count update
  updateSelectedCount();
});
</script>