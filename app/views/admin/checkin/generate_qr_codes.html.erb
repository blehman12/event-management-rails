<!-- Replace app/views/admin/checkin/generate_qr_codes.html.erb with this simplified version -->

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>QR Code Management: <%= @event.name %></h1>
        <div>
          <%= link_to "Back to Dashboard", checkin_dashboard_admin_event_path(@event), class: "btn btn-secondary" %>
          <% if @participants.where.not(qr_code_token: nil).any? %>
            <%= link_to "Print Badges", print_badges_admin_event_path(@event), class: "btn btn-success" %>
          <% end %>
        </div>
      </div>

      <!-- Generation Status -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card text-center border-primary">
            <div class="card-body">
              <h3 class="text-primary"><%= @participants.count %></h3>
              <h6>Total RSVP'd</h6>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center border-success">
            <div class="card-body">
              <h3 class="text-success"><%= @participants.where.not(qr_code_token: nil).count %></h3>
              <h6>QR Codes Generated</h6>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center border-warning">
            <div class="card-body">
              <h3 class="text-warning"><%= @missing_tokens %></h3>
              <h6>Missing QR Codes</h6>
            </div>
          </div>
        </div>
      </div>

      <!-- Generate QR Codes Section -->
      <% if @missing_tokens > 0 %>
        <div class="card mb-4">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">Generate Missing QR Codes</h5>
          </div>
          <div class="card-body">
            <p>There are <strong><%= @missing_tokens %></strong> participants without QR codes.</p>
            <%= form_with url: generate_qr_codes_admin_event_path(@event), method: :post, local: true do |form| %>
              <div class="d-grid gap-2">
                <%= form.submit "Generate QR Codes for All Participants", class: "btn btn-warning btn-lg" %>
              </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="alert alert-success">
          <h5>All QR Codes Generated</h5>
          <p class="mb-0">All RSVP'd participants have QR codes. You can now print badges or proceed with check-in.</p>
        </div>
      <% end %>

      <!-- Participants with QR Codes -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Participant QR Codes</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>RSVP Status</th>
                  <th>QR Code Status</th>
                  <th>QR Code URL</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @participants.each do |participant| %>
                  <tr>
                    <td>
                      <strong><%= participant.user.first_name %> <%= participant.user.last_name %></strong>
                    </td>
                    <td><%= participant.user.email %></td>
                    <td>
                      <span class="badge bg-<%= participant.rsvp_status == 'yes' ? 'success' : 'warning' %>">
                        <%= participant.rsvp_status_text %>
                      </span>
                    </td>
                    <td>
                      <% if participant.qr_code_token.present? %>
                        <span class="badge bg-success">Generated</span>
                      <% else %>
                        <span class="badge bg-warning">Missing</span>
                      <% end %>
                    </td>
                    <td>
                      <% if participant.qr_code_token.present? %>
                        <small><code><%= participant.qr_code_data %></code></small>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                    <td>
                      <% if participant.qr_code_token.present? %>
                        <a href="<%= participant.qr_code_data %>" 
                           target="_blank" 
                           class="btn btn-outline-primary btn-sm">
                          Test QR URL
                        </a>
                      <% else %>
                        <span class="text-muted">No QR Code</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- QR Code Testing Section -->
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="mb-0">Test QR Code System</h5>
        </div>
        <div class="card-body">
          <p>To test the QR code system:</p>
          <ol>
            <li>Click "Test QR URL" for any participant above</li>
            <li>This will open the check-in URL that would be in the QR code</li>
            <li>You should see the check-in verification page</li>
            <li>Use your phone's QR scanner on the printed badges</li>
          </ol>
          
          <div class="alert alert-info mt-3">
            <strong>Next Steps:</strong>
            <ul class="mb-0">
              <li>Click "Print Badges" to create printable name tags with QR codes</li>
              <li>Go to "Back to Dashboard" to see the check-in interface</li>
              <li>Use the bulk check-in for manual check-ins</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>